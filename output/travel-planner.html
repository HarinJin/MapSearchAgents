<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Travel Planner - Map Search Agents</title>

  <!-- Google Fonts: Inter for clean UI -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <!-- Leaflet MarkerCluster CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

  <style>
    /* ============================================
       CSS Variables & Reset
       ============================================ */
    :root {
      --left-w: 360px;
      --right-w: 380px;
      --header-h: 0px;
      --color-primary: #0EA5E9;
      --color-primary-light: #38BDF8;
      --color-primary-dark: #0369A1;
      --color-accent: #F97316;
      --color-accent-light: #FB923C;
      --color-bg: #F0F9FF;
      --color-surface: #FFFFFF;
      --color-border: #E2E8F0;
      --color-text: #0C4A6E;
      --color-text-secondary: #475569;
      --color-text-muted: #94A3B8;
      --color-success: #10B981;
      --color-warning: #F59E0B;
      --color-danger: #EF4444;
      --color-info: #3B82F6;
      --shadow-sm: 0 1px 2px rgba(0,0,0,0.06);
      --shadow-md: 0 4px 6px -1px rgba(14,165,233,0.1), 0 2px 4px -2px rgba(0,0,0,0.06);
      --shadow-lg: 0 10px 25px -5px rgba(14,165,233,0.15), 0 4px 6px -4px rgba(0,0,0,0.05);
      --shadow-xl: 0 20px 40px -10px rgba(14,165,233,0.2);
      --radius-sm: 6px;
      --radius-md: 10px;
      --radius-lg: 14px;
      --transition: 0.2s ease;
      /* Category colors */
      --cat-fd6: #EF4444;
      --cat-ce7: #10B981;
      --cat-at4: #0EA5E9;
      --cat-ct1: #8B5CF6;
      --cat-ad5: #F59E0B;
      --cat-hp8: #EC4899;
      --cat-default: #94A3B8;
      /* Day colors */
      --day-1: #0EA5E9;
      --day-2: #8B5CF6;
      --day-3: #10B981;
      --day-4: #F97316;
      --day-5: #EF4444;
      /* Focus ring */
      --focus-ring: 0 0 0 2px var(--color-surface), 0 0 0 4px var(--color-primary);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    /* Skip link for accessibility */
    .skip-link {
      position: absolute; top: -40px; left: 0; z-index: 9999;
      padding: 8px 16px; background: var(--color-primary); color: white;
      text-decoration: none; font-size: 0.85rem; font-weight: 600;
      border-radius: 0 0 var(--radius-sm) 0;
      transition: top 0.2s;
    }
    .skip-link:focus { top: 0; }

    /* Focus-visible styles for keyboard navigation */
    :focus-visible {
      outline: none;
      box-shadow: var(--focus-ring);
      border-radius: var(--radius-sm);
    }
    button:focus-visible, a:focus-visible, input:focus-visible, select:focus-visible, textarea:focus-visible {
      outline: none;
      box-shadow: var(--focus-ring);
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans KR', sans-serif;
      color: var(--color-text);
      background: var(--color-bg);
      overflow: hidden;
      height: 100vh;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* ============================================
       3-Panel Grid Layout
       ============================================ */
    .app-container {
      display: grid;
      grid-template-columns: var(--left-w) 1fr var(--right-w);
      height: 100vh;
      position: relative;
    }

    .app-container.left-collapsed { grid-template-columns: 0px 1fr var(--right-w); }
    .app-container.right-collapsed { grid-template-columns: var(--left-w) 1fr 0px; }
    .app-container.left-collapsed.right-collapsed { grid-template-columns: 0px 1fr 0px; }

    /* ============================================
       Panel Toggle Buttons
       ============================================ */
    .panel-toggle {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      z-index: 1000;
      width: 24px;
      height: 64px;
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      color: var(--color-text-secondary);
      box-shadow: var(--shadow-md);
      transition: background var(--transition);
    }
    .panel-toggle:hover { background: var(--color-bg); }
    .panel-toggle.left-toggle { left: var(--left-w); }
    .panel-toggle.right-toggle {
      right: var(--right-w);
      border-radius: var(--radius-sm) 0 0 var(--radius-sm);
    }
    .app-container.left-collapsed .panel-toggle.left-toggle { left: 0; }
    .app-container.right-collapsed .panel-toggle.right-toggle { right: 0; }

    /* ============================================
       Left Panel - Place List
       ============================================ */
    .left-panel {
      height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      background: var(--color-surface);
      border-right: 1px solid var(--color-border);
      transition: width var(--transition);
    }
    .app-container.left-collapsed .left-panel { width: 0; overflow: hidden; }

    .left-header {
      padding: 20px;
      background: linear-gradient(135deg, #0EA5E9 0%, #0369A1 50%, #0C4A6E 100%);
      color: white;
      flex-shrink: 0;
      position: relative;
      overflow: hidden;
    }
    .left-header::after {
      content: '';
      position: absolute; top: -50%; right: -30%;
      width: 200px; height: 200px;
      background: radial-gradient(circle, rgba(255,255,255,0.08) 0%, transparent 70%);
      border-radius: 50%;
      pointer-events: none;
    }
    .left-header h1 { font-size: 1.1rem; font-weight: 700; margin-bottom: 4px; letter-spacing: -0.01em; }
    .left-header .query-text { font-size: 0.85rem; opacity: 0.9; }
    .left-header .result-count {
      font-size: 0.75rem;
      opacity: 0.7;
      margin-top: 6px;
      font-weight: 500;
    }

    .filter-bar {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 16px;
      border-bottom: 1px solid var(--color-border);
      flex-shrink: 0;
      overflow-x: auto;
      white-space: nowrap;
    }
    .filter-chip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 500;
      border: 1.5px solid var(--color-border);
      background: var(--color-surface);
      color: var(--color-text-secondary);
      cursor: pointer;
      transition: all var(--transition);
      flex-shrink: 0;
    }
    .filter-chip:hover { border-color: var(--color-primary-light); color: var(--color-primary); }
    .filter-chip.active {
      background: var(--color-primary);
      color: white;
      border-color: var(--color-primary);
    }
    .filter-chip .chip-dot {
      width: 8px; height: 8px; border-radius: 50%;
    }

    .sort-select {
      margin-left: auto;
      padding: 4px 8px;
      border: 1px solid var(--color-border);
      border-radius: var(--radius-sm);
      font-size: 0.75rem;
      color: var(--color-text-secondary);
      background: var(--color-surface);
      cursor: pointer;
      flex-shrink: 0;
    }

    .scenario-banner {
      padding: 10px 16px;
      font-size: 0.8rem;
      display: flex;
      align-items: flex-start;
      gap: 8px;
      border-bottom: 1px solid var(--color-border);
      flex-shrink: 0;
    }
    .scenario-banner.info { background: #EFF6FF; color: #1E40AF; }
    .scenario-banner.warning { background: #FFFBEB; color: #92400E; }
    .scenario-banner .banner-icon { flex-shrink: 0; }

    .place-list {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
    }

    .category-section { margin-bottom: 8px; }
    .category-section-title {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--color-text-secondary);
      padding: 8px 8px 4px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .category-section-title .cat-dot {
      width: 10px; height: 10px; border-radius: 50%;
    }

    .place-card {
      position: relative;
      padding: 12px;
      margin-bottom: 4px;
      background: var(--color-surface);
      border-radius: var(--radius-md);
      border: 1px solid transparent;
      cursor: pointer;
      transition: all var(--transition);
      border-left: 3px solid transparent;
    }
    .place-card:hover {
      background: var(--color-bg);
      transform: translateX(2px);
      box-shadow: var(--shadow-sm);
    }
    .place-card.active {
      border-left-color: var(--color-primary);
      background: #E0F2FE;
      box-shadow: var(--shadow-md);
    }
    .place-card.in-plan::after {
      content: '';
      position: absolute;
      top: 8px; right: 8px;
      width: 8px; height: 8px;
      border-radius: 50%;
      background: var(--color-primary);
    }
    .place-card[draggable="true"] { cursor: grab; }
    .place-card.dragging { opacity: 0.5; }

    .place-card .card-top {
      display: flex;
      align-items: flex-start;
      gap: 8px;
    }
    .place-card .card-number {
      width: 24px; height: 24px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 0.7rem; font-weight: 700; color: white; flex-shrink: 0;
    }
    .place-card .card-info { flex: 1; min-width: 0; }
    .place-card .card-name {
      font-size: 0.9rem; font-weight: 600; color: var(--color-text);
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .place-card .card-detail-cat {
      font-size: 0.75rem; color: var(--color-text-muted); margin-top: 1px;
    }
    .place-card .card-address {
      font-size: 0.75rem; color: var(--color-text-secondary); margin-top: 4px;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .place-card .card-meta {
      display: flex; align-items: center; gap: 8px; margin-top: 6px;
      font-size: 0.75rem; color: var(--color-text-secondary);
      flex-wrap: wrap;
    }
    .place-card .card-rating { color: var(--color-warning); font-weight: 600; }
    .place-card .card-open { font-weight: 500; }
    .place-card .card-open.open { color: var(--color-success); }
    .place-card .card-open.closed { color: var(--color-danger); }
    .place-card .card-distance { color: var(--color-text-muted); }
    .place-card .card-closing-warning {
      font-size: 0.7rem; color: var(--color-warning); font-weight: 500;
    }

    .badge-row {
      display: flex; flex-wrap: wrap; gap: 4px; margin-top: 6px;
    }
    .badge {
      display: inline-flex; align-items: center; gap: 2px;
      padding: 2px 6px; border-radius: 999px;
      font-size: 0.65rem; font-weight: 500;
    }
    .badge.tag { background: #E0F2FE; color: #0369A1; }
    .badge.suit { background: #ECFDF5; color: #065F46; }
    .badge.trip-role { background: #FEF3C7; color: #92400E; }
    .badge.day-group { background: #F0F9FF; color: #0369A1; }
    .badge.disclaimer-badge { background: #FEF2F2; color: #991B1B; }

    .place-card .card-link {
      display: inline-block; margin-top: 6px;
      font-size: 0.7rem; color: var(--color-primary); text-decoration: none;
    }
    .place-card .card-link:hover { text-decoration: underline; }

    .place-card .add-to-plan-btn {
      display: none;
      position: absolute; top: 8px; right: 8px;
      padding: 4px 10px; border-radius: 999px;
      background: var(--color-accent); color: white;
      font-size: 0.65rem; font-weight: 600; border: none;
      cursor: pointer; z-index: 2;
      transition: background 0.15s ease, transform 0.1s ease;
      box-shadow: 0 2px 4px rgba(249,115,22,0.3);
    }
    .place-card .add-to-plan-btn:hover { background: #EA580C; }
    .place-card .add-to-plan-btn:active { transform: scale(0.95); }
    .place-card:hover .add-to-plan-btn { display: block; }
    .place-card.in-plan:hover .add-to-plan-btn { display: none; }

    .legend-bar {
      display: flex; flex-wrap: wrap; gap: 12px;
      padding: 10px 16px;
      border-top: 1px solid var(--color-border);
      font-size: 0.7rem; color: var(--color-text-secondary);
      flex-shrink: 0;
    }
    .legend-item { display: flex; align-items: center; gap: 4px; }
    .legend-dot { width: 10px; height: 10px; border-radius: 50%; }

    /* ============================================
       Center - Map
       ============================================ */
    .map-container {
      position: relative;
      height: 100vh;
    }
    #map { width: 100%; height: 100%; }

    .leaflet-popup-content { margin: 10px 14px; }
    .popup-name { font-weight: 600; font-size: 0.95rem; margin-bottom: 2px; }
    .popup-category { font-size: 0.75rem; color: var(--color-text-muted); margin-bottom: 4px; }
    .popup-meta { font-size: 0.8rem; color: var(--color-text-secondary); margin-bottom: 8px; }
    .popup-link {
      display: inline-block; padding: 5px 12px; border-radius: var(--radius-sm);
      background: var(--color-primary); color: white; text-decoration: none;
      font-size: 0.8rem; font-weight: 500;
    }
    .popup-link:hover { background: var(--color-primary-dark); }

    .custom-marker-icon {
      display: flex; align-items: center; justify-content: center;
      width: 30px; height: 30px; border-radius: 50%;
      color: white; font-size: 12px; font-weight: 700;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3); border: 2px solid white;
      transition: transform 0.15s ease;
    }
    .custom-marker-icon.selected {
      transform: scale(1.3);
      box-shadow: 0 3px 10px rgba(0,0,0,0.4);
    }

    /* ============================================
       Right Panel - Travel Planner
       ============================================ */
    .right-panel {
      height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      background: var(--color-surface);
      border-left: 1px solid var(--color-border);
      transition: width var(--transition);
    }
    .app-container.right-collapsed .right-panel { width: 0; overflow: hidden; }

    .right-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--color-border);
      flex-shrink: 0;
    }
    .right-header .header-top {
      display: flex; align-items: center; justify-content: space-between;
    }
    .right-header .plan-title-input {
      font-size: 1rem; font-weight: 600; border: none; outline: none;
      background: transparent; color: var(--color-text); width: 60%;
    }
    .right-header .plan-title-input::placeholder { color: var(--color-text-muted); }
    .right-header .header-actions {
      display: flex; gap: 6px;
    }
    .btn-icon {
      width: 32px; height: 32px; border-radius: var(--radius-sm);
      border: 1px solid var(--color-border); background: var(--color-surface);
      color: var(--color-text-secondary); cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      font-size: 14px; transition: all var(--transition);
    }
    .btn-icon:hover { background: var(--color-bg); color: var(--color-primary); }

    .day-tab-bar {
      display: flex; gap: 4px; padding: 8px 16px;
      border-bottom: 1px solid var(--color-border);
      overflow-x: auto; flex-shrink: 0;
    }
    .day-tab {
      padding: 6px 14px; border-radius: 999px;
      font-size: 0.8rem; font-weight: 500;
      border: 1.5px solid var(--color-border);
      background: var(--color-surface); color: var(--color-text-secondary);
      cursor: pointer; transition: all var(--transition);
      white-space: nowrap; flex-shrink: 0;
    }
    .day-tab:hover { border-color: var(--color-primary-light); }
    .day-tab.active {
      background: var(--color-primary); color: white;
      border-color: var(--color-primary);
    }
    .day-tab.add-day {
      border-style: dashed; color: var(--color-text-muted);
    }
    .day-tab.add-day:hover { border-color: var(--color-primary); color: var(--color-primary); }

    .day-itinerary {
      flex: 1; overflow-y: auto; padding: 12px 16px;
    }

    .itinerary-empty {
      display: flex; flex-direction: column; align-items: center;
      justify-content: center; height: 100%; color: var(--color-text-muted);
      text-align: center; padding: 20px;
    }
    .itinerary-empty .empty-icon { font-size: 2.5rem; margin-bottom: 12px; opacity: 0.5; }
    .itinerary-empty .empty-text { font-size: 0.85rem; line-height: 1.5; }

    .drop-zone {
      min-height: 60px; border: 2px dashed transparent;
      border-radius: var(--radius-md); transition: all var(--transition);
    }
    .drop-zone.drag-over {
      border-color: var(--color-primary-light);
      background: #E0F2FE;
    }

    .itinerary-slot {
      display: flex; gap: 8px; padding: 10px;
      background: var(--color-bg); border-radius: var(--radius-md);
      margin-bottom: 4px; position: relative;
      border: 1px solid transparent;
      transition: all var(--transition);
    }
    .itinerary-slot:hover { box-shadow: var(--shadow-sm); }
    .itinerary-slot.active {
      border-color: var(--color-primary-light); background: #E0F2FE;
    }
    .itinerary-slot.dragging { opacity: 0.4; }

    .itinerary-slot .drag-handle {
      cursor: grab; color: var(--color-text-muted); font-size: 14px;
      display: flex; align-items: center; padding: 0 2px;
      user-select: none;
    }
    .itinerary-slot .drag-handle:active { cursor: grabbing; }

    .itinerary-slot .slot-number {
      width: 22px; height: 22px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 0.65rem; font-weight: 700; color: white; flex-shrink: 0;
    }
    .itinerary-slot .slot-info { flex: 1; min-width: 0; }
    .itinerary-slot .slot-name {
      font-size: 0.85rem; font-weight: 600;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .itinerary-slot .slot-category {
      font-size: 0.7rem; color: var(--color-text-muted);
    }
    .itinerary-slot .slot-time-input {
      display: flex; align-items: center; gap: 4px; margin-top: 4px;
    }
    .itinerary-slot .slot-time-input input {
      width: 70px; padding: 2px 6px; border: 1px solid var(--color-border);
      border-radius: var(--radius-sm); font-size: 0.7rem;
      color: var(--color-text-secondary);
    }
    .itinerary-slot .slot-time-input span {
      font-size: 0.7rem; color: var(--color-text-muted);
    }
    .itinerary-slot .slot-note {
      width: 100%; margin-top: 4px; padding: 4px 6px;
      border: 1px solid transparent; border-radius: var(--radius-sm);
      font-size: 0.7rem; color: var(--color-text-secondary);
      background: transparent; resize: none; outline: none;
      font-family: inherit;
    }
    .itinerary-slot .slot-note:focus {
      border-color: var(--color-border); background: white;
    }
    .itinerary-slot .slot-remove {
      position: absolute; top: 4px; right: 4px;
      width: 20px; height: 20px; border-radius: 50%;
      border: none; background: transparent; color: var(--color-text-muted);
      cursor: pointer; font-size: 12px; display: none;
      align-items: center; justify-content: center;
    }
    .itinerary-slot:hover .slot-remove { display: flex; }
    .itinerary-slot .slot-remove:hover { background: #FEE2E2; color: var(--color-danger); }

    .route-segment-info {
      display: flex; align-items: center; justify-content: center;
      gap: 8px; padding: 4px 0; color: var(--color-text-muted);
      font-size: 0.7rem;
    }
    .route-segment-info .seg-line {
      width: 1px; height: 16px; background: var(--color-border);
    }
    .route-segment-info .seg-text {
      display: flex; align-items: center; gap: 4px;
    }

    .day-actions {
      display: flex; gap: 8px; padding: 12px 16px;
      border-top: 1px solid var(--color-border);
      flex-shrink: 0;
    }
    .btn {
      padding: 7px 14px; border-radius: var(--radius-sm);
      font-size: 0.8rem; font-weight: 500; border: 1px solid var(--color-border);
      background: var(--color-surface); color: var(--color-text-secondary);
      cursor: pointer; transition: all var(--transition);
    }
    .btn:hover { background: var(--color-bg); color: var(--color-primary); border-color: var(--color-primary-light); }
    .btn.btn-primary {
      background: var(--color-primary); color: white; border-color: var(--color-primary);
    }
    .btn.btn-primary:hover { background: var(--color-primary-dark); }

    .trip-summary {
      padding: 12px 16px;
      border-top: 1px solid var(--color-border);
      background: var(--color-bg);
      flex-shrink: 0;
    }
    .trip-summary .summary-row {
      display: flex; justify-content: space-between;
      font-size: 0.75rem; color: var(--color-text-secondary);
      margin-bottom: 2px;
    }
    .trip-summary .summary-value { font-weight: 600; color: var(--color-text); }

    /* ============================================
       Save/Load Modal
       ============================================ */
    .modal-overlay {
      display: none; position: fixed; inset: 0; z-index: 2000;
      background: rgba(0,0,0,0.4); align-items: center; justify-content: center;
      backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px);
    }
    .modal-overlay.visible { display: flex; }
    .modal {
      background: var(--color-surface); border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg); padding: 24px; width: 400px;
      max-height: 70vh; overflow-y: auto;
    }
    .modal h3 { font-size: 1rem; margin-bottom: 16px; }
    .modal .saved-plan-item {
      padding: 10px; border: 1px solid var(--color-border);
      border-radius: var(--radius-md); margin-bottom: 8px;
      cursor: pointer; transition: all var(--transition);
    }
    .modal .saved-plan-item:hover { border-color: var(--color-primary-light); background: var(--color-bg); }
    .modal .saved-plan-item .plan-name { font-weight: 600; font-size: 0.85rem; }
    .modal .saved-plan-item .plan-date { font-size: 0.7rem; color: var(--color-text-muted); }
    .modal .modal-close {
      margin-top: 12px; padding: 8px 20px; border-radius: var(--radius-sm);
      border: 1px solid var(--color-border); background: var(--color-surface);
      cursor: pointer; font-size: 0.85rem; width: 100%;
    }
    .modal .modal-close:hover { background: var(--color-bg); }

    /* ============================================
       Mobile Bottom Bar
       ============================================ */
    .mobile-bar {
      display: none;
      position: fixed; bottom: 0; left: 0; right: 0;
      background: var(--color-surface); border-top: 1px solid var(--color-border);
      z-index: 1100; padding: 8px;
    }
    .mobile-bar .tabs {
      display: flex; justify-content: center; gap: 4px;
    }
    .mobile-bar .tab-btn {
      flex: 1; padding: 12px; border: none; background: none;
      font-size: 0.8rem; font-weight: 500; color: var(--color-text-secondary);
      cursor: pointer; border-radius: var(--radius-md);
      text-align: center; min-height: 44px;
      transition: all var(--transition);
    }
    .mobile-bar .tab-btn:hover { background: var(--color-bg); }
    .mobile-bar .tab-btn.active {
      background: var(--color-primary); color: white;
      box-shadow: 0 2px 8px rgba(14,165,233,0.3);
    }

    /* ============================================
       Responsive
       ============================================ */
    @media (max-width: 1024px) {
      .app-container {
        grid-template-columns: 1fr;
      }
      .left-panel, .right-panel {
        position: fixed; top: 0; bottom: 48px; z-index: 1050;
        width: 100%; max-width: 400px;
      }
      .left-panel { left: 0; transform: translateX(-100%); }
      .left-panel.mobile-open { transform: translateX(0); }
      .right-panel { right: 0; transform: translateX(100%); }
      .right-panel.mobile-open { transform: translateX(0); }
      .map-container { height: calc(100vh - 48px); }
      .panel-toggle { display: none; }
      .mobile-bar { display: block; }
    }

    /* ============================================
       Scrollbar
       ============================================ */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--color-border); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--color-text-muted); }

    /* ============================================
       Animations
       ============================================ */
    @keyframes fadeIn { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes slideInLeft { from { opacity: 0; transform: translateX(-8px); } to { opacity: 1; transform: translateX(0); } }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
    .fade-in { animation: fadeIn 0.2s ease; }

    /* Button press micro-interaction */
    .btn:active, .day-tab:active, .filter-chip:active, .btn-icon:active {
      transform: scale(0.97);
    }
    .day-tab:active { transform: scale(0.95); }

    /* Smooth panel transitions on mobile */
    .left-panel, .right-panel {
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), width var(--transition);
    }

    /* Reduced motion for accessibility */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }

    /* High contrast mode improvements */
    @media (forced-colors: active) {
      .place-card.active { border: 2px solid CanvasText; }
      .filter-chip.active { border: 2px solid Highlight; }
      .custom-marker-icon { border: 2px solid CanvasText; }
    }
  </style>
</head>
<body>

  <!-- Skip link for keyboard users -->
  <a href="#map" class="skip-link">ÏßÄÎèÑÎ°ú Í±¥ÎÑàÎõ∞Í∏∞</a>

  <div class="app-container" id="appContainer" role="main">
    <!-- Left Panel -->
    <aside class="left-panel" id="leftPanel" aria-label="Ïû•ÏÜå Î™©Î°ù Ìå®ÎÑê">
      <div class="left-header" id="leftHeader"></div>
      <div class="filter-bar" id="filterBar" role="toolbar" aria-label="Ïπ¥ÌÖåÍ≥†Î¶¨ ÌïÑÌÑ∞"></div>
      <div id="scenarioBanners" role="status" aria-live="polite"></div>
      <div class="place-list" id="placeList" role="list" aria-label="Í≤ÄÏÉâ Í≤∞Í≥º Ïû•ÏÜå Î™©Î°ù"></div>
      <div class="legend-bar" id="legendBar" aria-label="Ïπ¥ÌÖåÍ≥†Î¶¨ Î≤îÎ°Ä"></div>
    </aside>

    <!-- Center Map -->
    <div class="map-container">
      <div id="map" role="application" aria-label="Ïû•ÏÜå ÏßÄÎèÑ"></div>
    </div>

    <!-- Right Panel -->
    <aside class="right-panel" id="rightPanel" aria-label="Ïó¨Ìñâ Í≥ÑÌöç Ìå®ÎÑê">
      <div class="right-header" id="rightHeader"></div>
      <div class="day-tab-bar" id="dayTabBar" role="tablist" aria-label="ÏùºÏ∞® ÏÑ†ÌÉù"></div>
      <div class="day-itinerary drop-zone" id="dayItinerary" role="tabpanel" aria-label="ÏùºÏ†ï Î™©Î°ù"></div>
      <div class="day-actions" id="dayActions"></div>
      <div class="trip-summary" id="tripSummary" aria-label="Ïó¨Ìñâ ÏöîÏïΩ"></div>
    </aside>
  </div>

  <!-- Panel Toggles -->
  <button class="panel-toggle left-toggle" id="leftToggle" aria-label="Ïû•ÏÜå Î™©Î°ù Ìå®ÎÑê Ï†ëÍ∏∞/ÌéºÏπòÍ∏∞" title="Ïû•ÏÜå Î™©Î°ù Ìå®ÎÑê Ï†ëÍ∏∞/ÌéºÏπòÍ∏∞"></button>
  <button class="panel-toggle right-toggle" id="rightToggle" aria-label="Ïó¨Ìñâ Í≥ÑÌöç Ìå®ÎÑê Ï†ëÍ∏∞/ÌéºÏπòÍ∏∞" title="Ïó¨Ìñâ Í≥ÑÌöç Ìå®ÎÑê Ï†ëÍ∏∞/ÌéºÏπòÍ∏∞"></button>

  <!-- Load Modal -->
  <div class="modal-overlay" id="loadModal" role="dialog" aria-modal="true" aria-labelledby="loadModalTitle">
    <div class="modal">
      <h3 id="loadModalTitle">Ï†ÄÏû•Îêú Ïó¨Ìñâ Í≥ÑÌöç</h3>
      <div id="savedPlansList"></div>
      <button class="modal-close" onclick="closeLoadModal()">Îã´Í∏∞</button>
    </div>
  </div>

  <!-- Mobile Bottom Bar -->
  <nav class="mobile-bar" id="mobileBar" aria-label="Ìå®ÎÑê Ï†ÑÌôò">
    <div class="tabs" role="tablist">
      <button class="tab-btn" role="tab" aria-selected="false" onclick="showMobilePanel('left')">Ïû•ÏÜå Î™©Î°ù</button>
      <button class="tab-btn active" role="tab" aria-selected="true" onclick="showMobilePanel('map')">ÏßÄÎèÑ</button>
      <button class="tab-btn" role="tab" aria-selected="false" onclick="showMobilePanel('right')">Ïó¨Ìñâ Í≥ÑÌöç</button>
    </div>
  </nav>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- Leaflet MarkerCluster JS -->
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <!-- Kakao Maps SDK (replace YOUR_KAKAO_JS_KEY with your JavaScript API key from Kakao Developers) -->
  <script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=YOUR_KAKAO_JS_KEY&libraries=services&autoload=false"
    onerror="window.__kakaoFailed=true"></script>

  <script>
    // ============================================
    // Configuration
    // ============================================
    const CONFIG = {
      kakaoJsKey: 'YOUR_KAKAO_JS_KEY', // Replace with your Kakao JS API key
      defaultZoom: 14,
      walkingSpeed: 80,   // meters per minute
      drivingSpeed: 500,  // meters per minute (30km/h urban)
    };

    // ============================================
    // Category Colors & Icons
    // ============================================
    const CATEGORY_COLORS = {
      FD6: 'var(--cat-fd6)', CE7: 'var(--cat-ce7)', AT4: 'var(--cat-at4)',
      CT1: 'var(--cat-ct1)', AD5: 'var(--cat-ad5)', HP8: 'var(--cat-hp8)',
      default: 'var(--cat-default)'
    };
    const CATEGORY_RAW_COLORS = {
      FD6: '#EF4444', CE7: '#10B981', AT4: '#0EA5E9',
      CT1: '#8B5CF6', AD5: '#F59E0B', HP8: '#EC4899',
      default: '#94A3B8'
    };
    const CATEGORY_ICONS = {
      FD6: 'üçΩÔ∏è', CE7: '‚òï', AT4: 'üèõÔ∏è', CT1: 'üé≠', AD5: 'üè®', HP8: 'üè•',
      default: 'üìç'
    };
    const CATEGORY_NAMES = {
      FD6: 'ÏùåÏãùÏ†ê', CE7: 'Ïπ¥Ìéò', AT4: 'Í¥ÄÍ¥ëÎ™ÖÏÜå', CT1: 'Î¨∏ÌôîÏãúÏÑ§', AD5: 'ÏàôÎ∞ï', HP8: 'Î≥ëÏõê'
    };
    const DAY_COLORS = ['#0EA5E9', '#8B5CF6', '#10B981', '#F97316', '#EF4444', '#EC4899', '#6366F1'];

    // ============================================
    // Sample APP_DATA
    // ============================================
    const APP_DATA = {
      query: "Ïû†Ïã§ Í∞ÄÏ°± Ïó¨Ìñâ 2Î∞ï3Ïùº ÏΩîÏä§",
      processedQuery: "Ïû†Ïã§ Í∞ÄÏ°± Ïó¨Ìñâ 2Î∞ï3Ïùº ÏΩîÏä§",
      queryType: "complex",
      scenarios: ["Ïó¨Ìñâ", "Ïú°ÏïÑ"],
      provider: "kakao",
      confidence: 0.9,
      searchParams: {
        location: { name: "Ïû†Ïã§Ïó≠", lat: 37.513311, lng: 127.100231 },
        destination: null,
        radius: 3000,
        keywords: ["Í∞ÄÏ°±", "ÏïÑÏù¥", "ÎÜÄÏù¥"],
        categoryCode: null,
        sort: "accuracy"
      },
      places: [
        {
          id: "27560699", displayName: "Î°ØÎç∞ÏõîÎìú Ïñ¥ÎìúÎ≤§Ï≤ò",
          formattedAddress: "ÏÑúÏö∏ ÏÜ°ÌååÍµ¨ Ïò¨Î¶ºÌîΩÎ°ú 240",
          roadAddress: "ÏÑúÏö∏ ÏÜ°ÌååÍµ¨ Ïò¨Î¶ºÌîΩÎ°ú 240",
          location: { latitude: 37.51113, longitude: 127.09812 },
          lat: 37.51113, lng: 127.09812,
          categoryCode: "AT4", categoryName: "Í¥ÄÍ¥ëÎ™ÖÏÜå > ÌÖåÎßàÌååÌÅ¨",
          categoryGroupName: "Í¥ÄÍ¥ëÎ™ÖÏÜå", detailCategory: "ÌÖåÎßàÌååÌÅ¨",
          phone: "1661-2000", placeUrl: "http://place.map.kakao.com/27560699",
          distance: 305, provider: "kakao",
          openNow: null, closingTime: null, closingWarning: null,
          rating: null, reviewCount: null, photoUrl: null,
          tags: ["ÏïÑÏù¥ ÎèôÎ∞ò", "Ïã§ÎÇ¥+ÏïºÏô∏"], suitability: ["Í∞ÄÏ°±", "Ïñ¥Î¶∞Ïù¥"],
          dayGroup: 1, tripRole: "Î©îÏù∏ Í¥ÄÍ¥ë", areaGroup: "Ïû†Ïã§",
          disclaimer: null
        },
        {
          id: "25974806", displayName: "Î°ØÎç∞ÏõîÎìú ÏïÑÏø†ÏïÑÎ¶¨ÏõÄ",
          formattedAddress: "ÏÑúÏö∏ ÏÜ°ÌååÍµ¨ Ïò¨Î¶ºÌîΩÎ°ú 300",
          roadAddress: "ÏÑúÏö∏ ÏÜ°ÌååÍµ¨ Ïò¨Î¶ºÌîΩÎ°ú 300",
          location: { latitude: 37.51345, longitude: 127.10480 },
          lat: 37.51345, lng: 127.10480,
          categoryCode: "AT4", categoryName: "Í¥ÄÍ¥ëÎ™ÖÏÜå > ÏïÑÏø†ÏïÑÎ¶¨ÏõÄ",
          categoryGroupName: "Í¥ÄÍ¥ëÎ™ÖÏÜå", detailCategory: "ÏïÑÏø†ÏïÑÎ¶¨ÏõÄ",
          phone: "1661-2000", placeUrl: "http://place.map.kakao.com/25974806",
          distance: 404, provider: "kakao",
          openNow: null, closingTime: null, closingWarning: null,
          rating: null, reviewCount: null, photoUrl: null,
          tags: ["ÏïÑÏù¥ ÎèôÎ∞ò", "Ïã§ÎÇ¥"], suitability: ["Í∞ÄÏ°±", "Ïñ¥Î¶∞Ïù¥"],
          dayGroup: 1, tripRole: "Ï≤¥Ìóò", areaGroup: "Ïû†Ïã§",
          disclaimer: null
        },
        {
          id: "11396413", displayName: "ÏÑùÏ¥åÌò∏Ïàò ÎèôÌò∏",
          formattedAddress: "ÏÑúÏö∏ ÏÜ°ÌååÍµ¨ Ïû†Ïã§Îèô",
          roadAddress: "ÏÑúÏö∏ ÏÜ°ÌååÍµ¨ ÏÑùÏ¥åÌò∏ÏàòÎ°ú 155",
          location: { latitude: 37.50855, longitude: 127.10325 },
          lat: 37.50855, lng: 127.10325,
          categoryCode: "AT4", categoryName: "Í¥ÄÍ¥ëÎ™ÖÏÜå > Í≥µÏõê",
          categoryGroupName: "Í¥ÄÍ¥ëÎ™ÖÏÜå", detailCategory: "Í≥µÏõê",
          phone: "", placeUrl: "http://place.map.kakao.com/11396413",
          distance: 580, provider: "kakao",
          openNow: null, closingTime: null, closingWarning: null,
          rating: null, reviewCount: null, photoUrl: null,
          tags: ["ÏÇ∞Ï±Ö", "ÎÑìÏùÄ Í≥µÍ∞Ñ"], suitability: ["Í∞ÄÏ°±", "Ïú†Î™®Ï∞®"],
          dayGroup: 2, tripRole: "ÏÇ∞Ï±Ö", areaGroup: "ÏÑùÏ¥åÌò∏Ïàò",
          disclaimer: null
        },
        {
          id: "21302210", displayName: "Ïï†ÏäêÎ¶¨ÌÄ∏Ï¶à Ïû†Ïã§Î°ØÎç∞Ï∫êÏä¨Ï†ê",
          formattedAddress: "ÏÑúÏö∏ ÏÜ°ÌååÍµ¨ Ïò¨Î¶ºÌîΩÎ°ú 269",
          roadAddress: "ÏÑúÏö∏ ÏÜ°ÌååÍµ¨ Ïò¨Î¶ºÌîΩÎ°ú 269",
          location: { latitude: 37.51456, longitude: 127.09976 },
          lat: 37.51456, lng: 127.09976,
          categoryCode: "FD6", categoryName: "ÏùåÏãùÏ†ê > Î∑îÌéò",
          categoryGroupName: "ÏùåÏãùÏ†ê", detailCategory: "Î∑îÌéò",
          phone: "02-2143-2995", placeUrl: "http://place.map.kakao.com/21302210",
          distance: 144, provider: "kakao",
          openNow: null, closingTime: null, closingWarning: null,
          rating: null, reviewCount: null, photoUrl: null,
          tags: ["ÎÑìÏùÄ Í≥µÍ∞Ñ"], suitability: ["Í∞ÄÏ°±", "Ïñ¥Î¶∞Ïù¥"],
          dayGroup: 1, tripRole: "ÏãùÏÇ¨", areaGroup: "Ïû†Ïã§",
          disclaimer: null
        },
        {
          id: "25972163", displayName: "Îß§ÎìúÌè¨Í∞àÎ¶≠ Î°ØÎç∞ÏãúÎÑ§ÎßàÏõîÎìúÌÉÄÏõåÏ†ê",
          formattedAddress: "ÏÑúÏö∏ ÏÜ°ÌååÍµ¨ Ïò¨Î¶ºÌîΩÎ°ú 300",
          roadAddress: "ÏÑúÏö∏ ÏÜ°ÌååÍµ¨ Ïò¨Î¶ºÌîΩÎ°ú 300",
          location: { latitude: 37.51399, longitude: 127.10456 },
          lat: 37.51399, lng: 127.10456,
          categoryCode: "FD6", categoryName: "ÏùåÏãùÏ†ê > Ïù¥ÌÉàÎ¶¨Ïïà",
          categoryGroupName: "ÏùåÏãùÏ†ê", detailCategory: "Ïù¥ÌÉàÎ¶¨Ïïà",
          phone: "02-3213-4001", placeUrl: "http://place.map.kakao.com/25972163",
          distance: 390, provider: "kakao",
          openNow: null, closingTime: null, closingWarning: null,
          rating: null, reviewCount: null, photoUrl: null,
          tags: [], suitability: ["Í∞ÄÏ°±"],
          dayGroup: 2, tripRole: "ÏãùÏÇ¨", areaGroup: "Ïû†Ïã§",
          disclaimer: null
        },
        {
          id: "172624697", displayName: "Ï∫êÎ°§Ïä§",
          formattedAddress: "ÏÑúÏö∏ ÏÜ°ÌååÍµ¨ Ïò¨Î¶ºÌîΩÎ°ú 300",
          roadAddress: "ÏÑúÏö∏ ÏÜ°ÌååÍµ¨ Ïò¨Î¶ºÌîΩÎ°ú 300",
          location: { latitude: 37.51320, longitude: 127.10389 },
          lat: 37.51320, lng: 127.10389,
          categoryCode: "FD6", categoryName: "ÏùåÏãùÏ†ê > Ìå®Î∞ÄÎ¶¨Î†àÏä§ÌÜ†Îûë",
          categoryGroupName: "ÏùåÏãùÏ†ê", detailCategory: "Ìå®Î∞ÄÎ¶¨Î†àÏä§ÌÜ†Îûë",
          phone: "02-3213-5432", placeUrl: "http://place.map.kakao.com/172624697",
          distance: 323, provider: "kakao",
          openNow: null, closingTime: null, closingWarning: null,
          rating: null, reviewCount: null, photoUrl: null,
          tags: ["ÏïÑÏù¥ ÎèôÎ∞ò"], suitability: ["Í∞ÄÏ°±", "Ïñ¥Î¶∞Ïù¥"],
          dayGroup: null, tripRole: "ÏãùÏÇ¨", areaGroup: "Ïû†Ïã§",
          disclaimer: null
        },
        {
          id: "11246062", displayName: "Ïä§ÌÉÄÎ≤ÖÏä§ Ïû†Ïã§Ïó≠Ï†ê",
          formattedAddress: "ÏÑúÏö∏ ÏÜ°ÌååÍµ¨ Ïò¨Î¶ºÌîΩÎ°ú ÏßÄÌïò 269",
          roadAddress: "ÏÑúÏö∏ ÏÜ°ÌååÍµ¨ Ïò¨Î¶ºÌîΩÎ°ú ÏßÄÌïò 269",
          location: { latitude: 37.51527, longitude: 127.09917 },
          lat: 37.51527, lng: 127.09917,
          categoryCode: "CE7", categoryName: "Ïπ¥Ìéò > Ïª§ÌîºÏ†ÑÎ¨∏Ï†ê",
          categoryGroupName: "Ïπ¥Ìéò", detailCategory: "Ïª§ÌîºÏ†ÑÎ¨∏Ï†ê",
          phone: "1522-3232", placeUrl: "http://place.map.kakao.com/11246062",
          distance: 236, provider: "kakao",
          openNow: null, closingTime: null, closingWarning: null,
          rating: null, reviewCount: null, photoUrl: null,
          tags: [], suitability: [],
          dayGroup: null, tripRole: "Ìú¥Ïãù", areaGroup: "Ïû†Ïã§Ïó≠",
          disclaimer: null
        },
        {
          id: "1959865002", displayName: "Îü∞ÎçòÎ≤†Ïù¥Í∏ÄÎÆ§ÏßÄÏóÑ Ïû†Ïã§Ï†ê",
          formattedAddress: "ÏÑúÏö∏ ÏÜ°ÌååÍµ¨ Ïò¨Î¶ºÌîΩÎ°ú 300",
          roadAddress: "ÏÑúÏö∏ ÏÜ°ÌååÍµ¨ Ïò¨Î¶ºÌîΩÎ°ú 300",
          location: { latitude: 37.51337, longitude: 127.10366 },
          lat: 37.51337, lng: 127.10366,
          categoryCode: "CE7", categoryName: "Ïπ¥Ìéò > Î≤†Ïù¥Ïª§Î¶¨",
          categoryGroupName: "Ïπ¥Ìéò", detailCategory: "Î≤†Ïù¥Ïª§Î¶¨",
          phone: "02-1234-5678", placeUrl: "http://place.map.kakao.com/1959865002",
          distance: 303, provider: "kakao",
          openNow: null, closingTime: null, closingWarning: null,
          rating: null, reviewCount: null, photoUrl: null,
          tags: [], suitability: [],
          dayGroup: 2, tripRole: "Ïπ¥Ìéò", areaGroup: "Ïû†Ïã§",
          disclaimer: null
        },
        {
          id: "21404892", displayName: "Îâ¥ÏßàÎûúÎìúÏä§ÌÜ†Î¶¨",
          formattedAddress: "ÏÑúÏö∏ ÏÜ°ÌååÍµ¨ ÏÑùÏ¥åÌò∏ÏàòÎ°ú 262",
          roadAddress: "ÏÑúÏö∏ ÏÜ°ÌååÍµ¨ ÏÑùÏ¥åÌò∏ÏàòÎ°ú 262",
          location: { latitude: 37.50969, longitude: 127.10585 },
          lat: 37.50969, lng: 127.10585,
          categoryCode: "CE7", categoryName: "Ïπ¥Ìéò > Ïπ¥Ìéò",
          categoryGroupName: "Ïπ¥Ìéò", detailCategory: "Ïπ¥Ìéò",
          phone: "02-421-3003", placeUrl: "http://place.map.kakao.com/21404892",
          distance: 638, provider: "kakao",
          openNow: null, closingTime: null, closingWarning: null,
          rating: null, reviewCount: null, photoUrl: null,
          tags: ["Î∑∞ Ï¢ãÏùÄ", "ÏÑùÏ¥åÌò∏Ïàò Î∑∞"], suitability: [],
          dayGroup: 2, tripRole: "Ïπ¥Ìéò", areaGroup: "ÏÑùÏ¥åÌò∏Ïàò",
          disclaimer: null
        },
        {
          id: "1766053303", displayName: "Ïû†Ïã§Î°ØÎç∞ÏõîÎìúÌÉÄÏõå ÏÑúÏö∏Ïä§Ïπ¥Ïù¥",
          formattedAddress: "ÏÑúÏö∏ ÏÜ°ÌååÍµ¨ Ïò¨Î¶ºÌîΩÎ°ú 300",
          roadAddress: "ÏÑúÏö∏ ÏÜ°ÌååÍµ¨ Ïò¨Î¶ºÌîΩÎ°ú 300 Î°ØÎç∞ÏõîÎìúÌÉÄÏõå 117~123F",
          location: { latitude: 37.51265, longitude: 127.10277 },
          lat: 37.51265, lng: 127.10277,
          categoryCode: "CT1", categoryName: "Î¨∏ÌôîÏãúÏÑ§ > Ï†ÑÎßùÎåÄ",
          categoryGroupName: "Î¨∏ÌôîÏãúÏÑ§", detailCategory: "Ï†ÑÎßùÎåÄ",
          phone: "1661-2000", placeUrl: "http://place.map.kakao.com/1766053303",
          distance: 250, provider: "kakao",
          openNow: null, closingTime: null, closingWarning: null,
          rating: null, reviewCount: null, photoUrl: null,
          tags: ["Ï†ÑÎßù", "Ìè¨ÌÜ†Ïä§Ìåü"], suitability: ["Í∞ÄÏ°±"],
          dayGroup: 1, tripRole: "Í¥ÄÍ¥ë", areaGroup: "Ïû†Ïã§",
          disclaimer: null
        },
        {
          id: "sig001", displayName: "ÏãúÍ∑∏ÎãàÏóòÏÑúÏö∏",
          formattedAddress: "ÏÑúÏö∏ ÏÜ°ÌååÍµ¨ Ïò¨Î¶ºÌîΩÎ°ú 300 76~101F",
          roadAddress: "ÏÑúÏö∏ ÏÜ°ÌååÍµ¨ Ïò¨Î¶ºÌîΩÎ°ú 300 76~101F",
          location: { latitude: 37.51280, longitude: 127.10250 },
          lat: 37.51280, lng: 127.10250,
          categoryCode: "AD5", categoryName: "ÏàôÎ∞ï > Ìò∏ÌÖî",
          categoryGroupName: "ÏàôÎ∞ï", detailCategory: "Ìò∏ÌÖî",
          phone: "02-3213-1000", placeUrl: "http://place.map.kakao.com/sig001",
          distance: 280, provider: "kakao",
          openNow: null, closingTime: null, closingWarning: null,
          rating: null, reviewCount: null, photoUrl: null,
          tags: ["Í≥†Í∏â", "Î∑∞ Ï¢ãÏùÄ"], suitability: ["Í∞ÄÏ°±"],
          dayGroup: 1, tripRole: "ÏàôÏÜå", areaGroup: "Ïû†Ïã§",
          disclaimer: null
        },
        {
          id: "oly001", displayName: "Ïò¨Î¶ºÌîΩÍ≥µÏõê",
          formattedAddress: "ÏÑúÏö∏ ÏÜ°ÌååÍµ¨ Ïò¨Î¶ºÌîΩÎ°ú 424",
          roadAddress: "ÏÑúÏö∏ ÏÜ°ÌååÍµ¨ Ïò¨Î¶ºÌîΩÎ°ú 424",
          location: { latitude: 37.52100, longitude: 127.12150 },
          lat: 37.52100, lng: 127.12150,
          categoryCode: "AT4", categoryName: "Í¥ÄÍ¥ëÎ™ÖÏÜå > Í≥µÏõê",
          categoryGroupName: "Í¥ÄÍ¥ëÎ™ÖÏÜå", detailCategory: "Í≥µÏõê",
          phone: "02-410-1114", placeUrl: "http://place.map.kakao.com/oly001",
          distance: 2100, provider: "kakao",
          openNow: null, closingTime: null, closingWarning: null,
          rating: null, reviewCount: null, photoUrl: null,
          tags: ["ÎÑìÏùÄ Í≥µÍ∞Ñ", "ÏÇ∞Ï±Ö", "ÏûêÏ†ÑÍ±∞"], suitability: ["Í∞ÄÏ°±", "Ïú†Î™®Ï∞®"],
          dayGroup: 3, tripRole: "ÏÇ∞Ï±Ö", areaGroup: "Ïò¨Î¶ºÌîΩÍ≥µÏõê",
          disclaimer: null
        }
      ],
      timeCondition: null,
      limitations: ["Ï†ëÍ∑ºÏÑ± Ï†ïÎ≥¥(Ïú†Î™®Ï∞®, ÏàòÏú†Ïã§ Îì±)Îäî Î∞©Î¨∏ Ï†Ñ ÌôïÏù∏ÏùÑ Í∂åÏû•Ìï©ÎãàÎã§"],
      meta: {
        apiCalls: 4, strategyUsed: "multi_keyword",
        duplicatesRemoved: 2, enrichmentStatus: "none"
      }
    };

    // ============================================
    // App State
    // ============================================
    const AppState = {
      selectedPlaceId: null,
      activeDay: 1,
      leftPanelOpen: true,
      rightPanelOpen: true,
      activeCategories: new Set(),
      sortBy: 'distance',
      travelPlan: {
        title: '',
        days: [
          { label: '1ÏùºÏ∞®', places: [], notes: {}, timeSlots: {} },
          { label: '2ÏùºÏ∞®', places: [], notes: {}, timeSlots: {} },
          { label: '3ÏùºÏ∞®', places: [], notes: {}, timeSlots: {} }
        ]
      },
      markers: {},
      routeLines: [],
      _listeners: []
    };

    function subscribe(fn) { AppState._listeners.push(fn); }
    function notify(changed) { AppState._listeners.forEach(fn => fn(changed)); }

    function setState(updates, changed) {
      Object.assign(AppState, updates);
      notify(changed || Object.keys(updates));
    }

    // ============================================
    // Utilities
    // ============================================
    function haversineDistance(lat1, lon1, lat2, lon2) {
      const R = 6371000;
      const toRad = d => d * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2)**2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    function formatDistance(meters) {
      if (meters >= 1000) return (meters / 1000).toFixed(1) + 'km';
      return Math.round(meters) + 'm';
    }

    function formatTravelTime(meters) {
      const walkMin = Math.round(meters / CONFIG.walkingSpeed);
      const driveMin = Math.round(meters / CONFIG.drivingSpeed);
      const parts = [];
      if (walkMin > 0) parts.push(`ÎèÑÎ≥¥ ${walkMin}Î∂Ñ`);
      if (driveMin > 0) parts.push(`Ï∞®Îüâ ${driveMin}Î∂Ñ`);
      else parts.push('Ï∞®Îüâ 1Î∂Ñ ÎØ∏Îßå');
      return parts.join(' / ');
    }

    function getCatColor(code) { return CATEGORY_RAW_COLORS[code] || CATEGORY_RAW_COLORS.default; }
    function getCatIcon(code) { return CATEGORY_ICONS[code] || CATEGORY_ICONS.default; }
    function getCatName(code) { return CATEGORY_NAMES[code] || 'Í∏∞ÌÉÄ'; }
    function getDayColor(dayIdx) { return DAY_COLORS[(dayIdx - 1) % DAY_COLORS.length]; }

    function isPlaceInPlan(placeId) {
      return AppState.travelPlan.days.some(d => d.places.some(p => p.id === placeId));
    }

    function getPlaceById(id) { return APP_DATA.places.find(p => p.id === id); }

    function getFilteredPlaces() {
      let places = [...APP_DATA.places];
      if (AppState.activeCategories.size > 0) {
        places = places.filter(p => AppState.activeCategories.has(p.categoryCode));
      }
      if (AppState.sortBy === 'distance') {
        places.sort((a, b) => (a.distance || Infinity) - (b.distance || Infinity));
      }
      return places;
    }

    function groupByCategory(places) {
      const groups = {};
      places.forEach(p => {
        const key = p.categoryCode || 'default';
        if (!groups[key]) groups[key] = [];
        groups[key].push(p);
      });
      return groups;
    }

    // ============================================
    // Map Adapter (Leaflet-based, Kakao-ready)
    // ============================================
    let mapInstance = null;
    let clusterGroup = null;
    const mapMarkers = {};
    let mapRouteLines = [];

    const MapAdapter = {
      init(containerId, center, zoom) {
        mapInstance = L.map(containerId).setView([center.lat, center.lng], zoom || CONFIG.defaultZoom);
        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19,
          attribution: '&copy; <a href="https://openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(mapInstance);
        clusterGroup = L.markerClusterGroup({
          maxClusterRadius: 40,
          spiderfyOnMaxZoom: true,
          showCoverageOnHover: false,
          iconCreateFunction: function(cluster) {
            const count = cluster.getChildCount();
            return L.divIcon({
              html: `<div style="background:var(--color-primary);color:white;width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;border:2px solid white;box-shadow:0 2px 6px rgba(0,0,0,0.3)">${count}</div>`,
              className: '', iconSize: [36, 36], iconAnchor: [18, 18]
            });
          }
        });
        mapInstance.addLayer(clusterGroup);
      },

      addMarker(place, index) {
        const color = getCatColor(place.categoryCode);
        const icon = L.divIcon({
          className: '',
          html: `<div class="custom-marker-icon" data-id="${place.id}" style="background:${color}">${index + 1}</div>`,
          iconSize: [30, 30], iconAnchor: [15, 15], popupAnchor: [0, -18]
        });

        const marker = L.marker([place.lat, place.lng], { icon });
        marker.placeId = place.id;

        const popupHtml = MapAdapter._createPopup(place);
        marker.bindPopup(popupHtml, { maxWidth: 260 });

        marker.on('click', () => {
          selectPlace(place.id, 'map');
        });

        clusterGroup.addLayer(marker);
        mapMarkers[place.id] = marker;
      },

      _createPopup(place) {
        let meta = '';
        if (place.rating !== null) meta += `<span style="color:#F59E0B;font-weight:600">‚≠ê ${place.rating}</span> `;
        if (place.reviewCount !== null) meta += `(${place.reviewCount.toLocaleString()}) `;
        if (place.openNow === true) meta += `<span style="color:#10B981">üü¢ ÏòÅÏóÖÏ§ë</span> `;
        else if (place.openNow === false) meta += `<span style="color:#EF4444">üî¥ ÏòÅÏóÖÏ¢ÖÎ£å</span> `;
        if (place.distance) meta += `<span style="color:#94A3B8">${formatDistance(place.distance)}</span>`;

        return `
          <div class="popup-name">${place.displayName}</div>
          <div class="popup-category">${place.detailCategory || place.categoryGroupName}</div>
          ${meta ? `<div class="popup-meta">${meta}</div>` : ''}
          <a href="${place.placeUrl}" target="_blank" class="popup-link" onclick="event.stopPropagation()">
            ${place.provider === 'google' ? 'Google Maps' : 'Ïπ¥Ïπ¥Ïò§Îßµ'}ÏóêÏÑú Î≥¥Í∏∞
          </a>
        `;
      },

      highlightMarker(placeId) {
        Object.values(mapMarkers).forEach(m => {
          const el = m.getElement();
          if (el) el.querySelector('.custom-marker-icon')?.classList.remove('selected');
        });
        const marker = mapMarkers[placeId];
        if (marker) {
          const el = marker.getElement();
          if (el) el.querySelector('.custom-marker-icon')?.classList.add('selected');
        }
      },

      panTo(lat, lng, zoom) {
        if (mapInstance) mapInstance.setView([lat, lng], zoom || 16, { animate: true });
      },

      openPopup(placeId) {
        const marker = mapMarkers[placeId];
        if (marker) {
          // If in cluster, spiderfy first
          const parent = clusterGroup.getVisibleParent(marker);
          if (parent && parent !== marker) {
            mapInstance.setView(marker.getLatLng(), 17, { animate: true });
            setTimeout(() => marker.openPopup(), 400);
          } else {
            marker.openPopup();
          }
        }
      },

      fitBounds(places) {
        if (!places || places.length === 0) return;
        const coords = places.map(p => [p.lat, p.lng]);
        mapInstance.fitBounds(coords, { padding: [60, 60], maxZoom: 16 });
      },

      clearRouteLines() {
        mapRouteLines.forEach(l => mapInstance.removeLayer(l));
        mapRouteLines = [];
      },

      addRouteLine(coords, options = {}) {
        const line = L.polyline(coords, {
          color: options.color || '#4F46E5',
          weight: options.weight || 3,
          opacity: options.opacity || 0.7,
          dashArray: options.dashed ? '8, 8' : null
        }).addTo(mapInstance);
        mapRouteLines.push(line);
        return line;
      },

      drawItineraryRoute(dayIndex) {
        MapAdapter.clearRouteLines();
        const day = AppState.travelPlan.days[dayIndex - 1];
        if (!day || day.places.length < 2) return;

        const color = getDayColor(dayIndex);
        const coords = day.places.map(p => [p.lat, p.lng]);
        MapAdapter.addRouteLine(coords, { color, weight: 3, opacity: 0.6 });
      },

      invalidateSize() {
        if (mapInstance) setTimeout(() => mapInstance.invalidateSize(), 100);
      },

      removeAllMarkers() {
        clusterGroup.clearLayers();
        Object.keys(mapMarkers).forEach(k => delete mapMarkers[k]);
      }
    };

    // ============================================
    // Render: Left Panel
    // ============================================
    function renderLeftHeader() {
      const el = document.getElementById('leftHeader');
      const pinSvg = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:-1px;opacity:0.85"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/><circle cx="12" cy="10" r="3"/></svg>';
      el.innerHTML = `
        <h1>${APP_DATA.query}</h1>
        <div class="query-text">${pinSvg} ${APP_DATA.searchParams.location?.name || ''} ${APP_DATA.searchParams.radius ? `Î∞òÍ≤Ω ${(APP_DATA.searchParams.radius/1000).toFixed(0)}km` : ''}</div>
        <div class="result-count">${APP_DATA.places.length}Í∞ú Ïû•ÏÜå ¬∑ ${APP_DATA.scenarios.join(', ')} ÏãúÎÇòÎ¶¨Ïò§</div>
      `;
    }

    function renderFilterBar() {
      const el = document.getElementById('filterBar');
      const cats = [...new Set(APP_DATA.places.map(p => p.categoryCode))];

      let html = '';
      cats.forEach(code => {
        const isActive = AppState.activeCategories.has(code);
        html += `<button class="filter-chip ${isActive ? 'active' : ''}" data-cat="${code}" aria-pressed="${isActive}" onclick="toggleCategory('${code}')">
          <span class="chip-dot" style="background:${getCatColor(code)}"></span>
          ${getCatName(code)}
        </button>`;
      });

      html += `<select class="sort-select" onchange="changeSortBy(this.value)" aria-label="Ï†ïÎ†¨ Í∏∞Ï§Ä">
        <option value="distance" ${AppState.sortBy === 'distance' ? 'selected' : ''}>Í±∞Î¶¨Ïàú</option>
        <option value="relevance" ${AppState.sortBy === 'relevance' ? 'selected' : ''}>Í¥ÄÎ†®ÎèÑÏàú</option>
      </select>`;

      el.innerHTML = html;
    }

    function renderScenarioBanners() {
      const el = document.getElementById('scenarioBanners');
      let html = '';

      if (APP_DATA.timeCondition) {
        html += `<div class="scenario-banner info">
          <span class="banner-icon">‚è∞</span>
          <span>${APP_DATA.timeCondition.userGuidance || 'ÏãúÍ∞Ñ Ï°∞Í±¥Ïù¥ Ï†ÅÏö©ÎêòÏóàÏäµÎãàÎã§'}</span>
        </div>`;
      }

      const hasDisclaimer = APP_DATA.places.some(p => p.disclaimer);
      if (hasDisclaimer) {
        html += `<div class="scenario-banner warning">
          <span class="banner-icon">‚ö†Ô∏è</span>
          <span>Î∞òÎ†§ÎèôÎ¨º ÎèôÎ∞ò Í∞ÄÎä• Ïó¨Î∂ÄÎäî Î∞©Î¨∏ Ï†Ñ Îß§Ïû•Ïóê ÏßÅÏ†ë ÌôïÏù∏ÏùÑ Í∂åÏû•Ìï©ÎãàÎã§</span>
        </div>`;
      }

      if (APP_DATA.provider === 'google') {
        html += `<div class="scenario-banner info">
          <span class="banner-icon">üåè</span>
          <span>Ìï¥Ïô∏ Ïû•ÏÜå Ï†ïÎ≥¥Îäî Ïã§Ï†úÏôÄ Îã§Î•º Ïàò ÏûàÏäµÎãàÎã§</span>
        </div>`;
      }

      if (APP_DATA.limitations?.length > 0) {
        APP_DATA.limitations.forEach(lim => {
          html += `<div class="scenario-banner info">
            <span class="banner-icon">‚ÑπÔ∏è</span>
            <span>${lim}</span>
          </div>`;
        });
      }

      el.innerHTML = html;
    }

    function renderPlaceList() {
      const el = document.getElementById('placeList');
      const places = getFilteredPlaces();
      const groups = groupByCategory(places);

      if (places.length === 0) {
        el.innerHTML = `<div class="itinerary-empty">
          <div class="empty-icon">üîç</div>
          <div class="empty-text">Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§.<br>ÌïÑÌÑ∞Î•º Î≥ÄÍ≤ΩÌïòÍ±∞ÎÇò Í≤ÄÏÉâ Î≤îÏúÑÎ•º ÎÑìÌòÄÎ≥¥ÏÑ∏Ïöî.</div>
        </div>`;
        return;
      }

      let html = '';
      let globalIndex = 0;

      Object.entries(groups).forEach(([catCode, catPlaces]) => {
        html += `<div class="category-section">
          <div class="category-section-title">
            <span class="cat-dot" style="background:${getCatColor(catCode)}"></span>
            ${getCatIcon(catCode)} ${getCatName(catCode)} (${catPlaces.length})
          </div>`;

        catPlaces.forEach(place => {
          const idx = APP_DATA.places.indexOf(place);
          const isActive = AppState.selectedPlaceId === place.id;
          const inPlan = isPlaceInPlan(place.id);

          html += `<div class="place-card fade-in ${isActive ? 'active' : ''} ${inPlan ? 'in-plan' : ''}"
            role="listitem" data-id="${place.id}" draggable="true"
            aria-label="${place.displayName}"
            onclick="selectPlace('${place.id}', 'list')"
            ondragstart="onPlaceDragStart(event, '${place.id}')">
            <button class="add-to-plan-btn" onclick="event.stopPropagation(); addToPlan('${place.id}')" aria-label="${place.displayName} ÏùºÏ†ïÏóê Ï∂îÍ∞Ä">+ ÏùºÏ†ï Ï∂îÍ∞Ä</button>
            <div class="card-top">
              <div class="card-number" style="background:${getCatColor(place.categoryCode)}">${idx + 1}</div>
              <div class="card-info">
                <div class="card-name">${place.displayName}</div>
                <div class="card-detail-cat">${place.detailCategory || place.categoryGroupName}</div>
              </div>
            </div>
            <div class="card-address">${place.roadAddress || place.formattedAddress}</div>
            <div class="card-meta">
              ${place.rating !== null ? `<span class="card-rating">‚≠ê ${place.rating}${place.reviewCount ? ` (${place.reviewCount.toLocaleString()})` : ''}</span>` : ''}
              ${place.openNow === true ? '<span class="card-open open">üü¢ ÏòÅÏóÖÏ§ë</span>' : ''}
              ${place.openNow === false ? '<span class="card-open closed">üî¥ ÏòÅÏóÖÏ¢ÖÎ£å</span>' : ''}
              ${place.distance ? `<span class="card-distance">${formatDistance(place.distance)}</span>` : ''}
            </div>
            ${place.closingWarning ? `<div class="card-closing-warning">‚ö†Ô∏è ${place.closingWarning}</div>` : ''}
            ${renderBadges(place)}
            <a href="${place.placeUrl}" target="_blank" class="card-link" onclick="event.stopPropagation()">${place.provider === 'google' ? 'Google Maps' : 'Ïπ¥Ïπ¥Ïò§Îßµ'}ÏóêÏÑú Î≥¥Í∏∞ ‚Üí</a>
          </div>`;
          globalIndex++;
        });

        html += '</div>';
      });

      el.innerHTML = html;
    }

    function renderBadges(place) {
      let badges = '';
      if (place.tags?.length) {
        badges += place.tags.map(t => `<span class="badge tag">${t}</span>`).join('');
      }
      if (place.suitability?.length) {
        badges += place.suitability.map(s => `<span class="badge suit">${s}</span>`).join('');
      }
      if (place.tripRole) {
        badges += `<span class="badge trip-role">${place.tripRole}</span>`;
      }
      if (place.dayGroup !== null && place.dayGroup !== undefined) {
        badges += `<span class="badge day-group">${place.dayGroup}ÏùºÏ∞®</span>`;
      }
      if (place.disclaimer) {
        badges += `<span class="badge disclaimer-badge">‚ö†Ô∏è ÌôïÏù∏ÌïÑÏöî</span>`;
      }
      return badges ? `<div class="badge-row">${badges}</div>` : '';
    }

    function renderLegend() {
      const el = document.getElementById('legendBar');
      const cats = [...new Set(APP_DATA.places.map(p => p.categoryCode))];
      el.innerHTML = cats.map(code =>
        `<div class="legend-item"><span class="legend-dot" style="background:${getCatColor(code)}"></span>${getCatName(code)}</div>`
      ).join('');
    }

    // ============================================
    // Render: Map Markers
    // ============================================
    function renderMapMarkers() {
      MapAdapter.removeAllMarkers();
      const places = getFilteredPlaces();
      places.forEach((place, i) => {
        const idx = APP_DATA.places.indexOf(place);
        MapAdapter.addMarker(place, idx);
      });
    }

    // ============================================
    // Render: Right Panel
    // ============================================
    function renderRightHeader() {
      const el = document.getElementById('rightHeader');
      el.innerHTML = `
        <div class="header-top">
          <input class="plan-title-input" type="text" placeholder="Ïó¨Ìñâ Ï†úÎ™©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
            value="${AppState.travelPlan.title}"
            onchange="AppState.travelPlan.title = this.value"
            aria-label="Ïó¨Ìñâ Í≥ÑÌöç Ï†úÎ™©">
          <div class="header-actions">
            <button class="btn-icon" onclick="savePlan()" title="Ï†ÄÏû•" aria-label="Ïó¨Ìñâ Í≥ÑÌöç Ï†ÄÏû•">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
            </button>
            <button class="btn-icon" onclick="openLoadModal()" title="Î∂àÎü¨Ïò§Í∏∞" aria-label="Ï†ÄÏû•Îêú Ïó¨Ìñâ Í≥ÑÌöç Î∂àÎü¨Ïò§Í∏∞">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg>
            </button>
          </div>
        </div>
      `;
    }

    function renderDayTabs() {
      const el = document.getElementById('dayTabBar');
      let html = '';
      AppState.travelPlan.days.forEach((day, i) => {
        const dayNum = i + 1;
        const isActive = AppState.activeDay === dayNum;
        const count = day.places.length;
        html += `<button class="day-tab ${isActive ? 'active' : ''}" role="tab" aria-selected="${isActive}" style="${isActive ? `background:${getDayColor(dayNum)};border-color:${getDayColor(dayNum)}` : ''}"
          onclick="switchDay(${dayNum})">${day.label}${count ? ` (${count})` : ''}</button>`;
      });
      html += `<button class="day-tab add-day" onclick="addDay()">+ Ï∂îÍ∞Ä</button>`;
      el.innerHTML = html;
    }

    function renderDayItinerary() {
      const el = document.getElementById('dayItinerary');
      const day = AppState.travelPlan.days[AppState.activeDay - 1];
      if (!day) return;

      if (day.places.length === 0) {
        el.innerHTML = `<div class="itinerary-empty">
          <div class="empty-icon">üìã</div>
          <div class="empty-text">Ï¢åÏ∏°ÏóêÏÑú Ïû•ÏÜåÎ•º ÎìúÎûòÍ∑∏ÌïòÍ±∞ÎÇò<br>"+ ÏùºÏ†ï Ï∂îÍ∞Ä" Î≤ÑÌäºÏúºÎ°ú ÏùºÏ†ïÏùÑ ÎßåÎì§Ïñ¥Î≥¥ÏÑ∏Ïöî</div>
        </div>`;
        return;
      }

      let html = '';
      day.places.forEach((place, i) => {
        const isActive = AppState.selectedPlaceId === place.id;
        const color = getDayColor(AppState.activeDay);
        const timeSlot = day.timeSlots[place.id] || {};
        const note = day.notes[place.id] || '';

        html += `<div class="itinerary-slot ${isActive ? 'active' : ''}" data-id="${place.id}" data-index="${i}"
          draggable="true"
          onclick="selectPlace('${place.id}', 'itinerary')"
          ondragstart="onSlotDragStart(event, ${i})"
          ondragover="onSlotDragOver(event)"
          ondrop="onSlotDrop(event, ${i})">
          <div class="drag-handle">‚â°</div>
          <div class="slot-number" style="background:${color}">${i + 1}</div>
          <div class="slot-info">
            <div class="slot-name">${place.displayName}</div>
            <div class="slot-category">${getCatIcon(place.categoryCode)} ${place.detailCategory || place.categoryGroupName}${place.tripRole ? ` ¬∑ ${place.tripRole}` : ''}</div>
            <div class="slot-time-input">
              <input type="time" value="${timeSlot.start || ''}"
                onchange="updateTimeSlot('${place.id}', 'start', this.value)" placeholder="ÏãúÏûë">
              <span>~</span>
              <input type="time" value="${timeSlot.end || ''}"
                onchange="updateTimeSlot('${place.id}', 'end', this.value)" placeholder="Ï¢ÖÎ£å">
            </div>
            <textarea class="slot-note" rows="1" placeholder="Î©îÎ™®..."
              onchange="updateNote('${place.id}', this.value)">${note}</textarea>
          </div>
          <button class="slot-remove" onclick="event.stopPropagation(); removeFromPlan(${i})">‚úï</button>
        </div>`;

        // Route segment info between slots
        if (i < day.places.length - 1) {
          const next = day.places[i + 1];
          const dist = haversineDistance(place.lat, place.lng, next.lat, next.lng);
          html += `<div class="route-segment-info">
            <div class="seg-line"></div>
            <div class="seg-text">
              <span>${formatDistance(dist)}</span> ¬∑ <span>${formatTravelTime(dist)}</span>
            </div>
            <div class="seg-line"></div>
          </div>`;
        }
      });

      el.innerHTML = html;
    }

    function renderDayActions() {
      const el = document.getElementById('dayActions');
      const day = AppState.travelPlan.days[AppState.activeDay - 1];
      const hasPlaces = day && day.places.length >= 2;
      el.innerHTML = `
        <button class="btn" onclick="optimizeRoute()" ${!hasPlaces ? 'disabled style="opacity:0.5;cursor:not-allowed"' : ''} aria-label="Í≤ΩÎ°ú ÏµúÏ†ÅÌôî">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:-2px;margin-right:4px"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/></svg>Í≤ΩÎ°ú ÏµúÏ†ÅÌôî
        </button>
        <button class="btn" onclick="clearDay()" aria-label="ÏùºÏ∞® Ï¥àÍ∏∞Ìôî">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:-2px;margin-right:4px"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>ÏùºÏ∞® Ï¥àÍ∏∞Ìôî
        </button>
      `;
    }

    function renderTripSummary() {
      const el = document.getElementById('tripSummary');
      const days = AppState.travelPlan.days;
      const totalPlaces = days.reduce((sum, d) => sum + d.places.length, 0);
      let totalDist = 0;
      days.forEach(d => {
        for (let i = 0; i < d.places.length - 1; i++) {
          totalDist += haversineDistance(d.places[i].lat, d.places[i].lng, d.places[i+1].lat, d.places[i+1].lng);
        }
      });

      el.innerHTML = `
        <div class="summary-row"><span>Ï¥ù ÏùºÏàò</span><span class="summary-value">${days.length}Ïùº</span></div>
        <div class="summary-row"><span>Ï¥ù Ïû•ÏÜå</span><span class="summary-value">${totalPlaces}Í≥≥</span></div>
        <div class="summary-row"><span>Ï¥ù Ïù¥Îèô Í±∞Î¶¨</span><span class="summary-value">${formatDistance(totalDist)}</span></div>
      `;
    }

    // ============================================
    // Master Render
    // ============================================
    function render(changed) {
      if (!changed || changed.includes('activeCategories') || changed.includes('sortBy')) {
        renderFilterBar();
        renderPlaceList();
        renderMapMarkers();
      }
      if (!changed || changed.includes('selectedPlaceId')) {
        updatePlaceCardHighlights();
        updateSlotHighlights();
      }
      if (!changed || changed.includes('activeDay') || changed.includes('travelPlan')) {
        renderDayTabs();
        renderDayItinerary();
        renderDayActions();
        renderTripSummary();
        MapAdapter.drawItineraryRoute(AppState.activeDay);
        updateInPlanMarkers();
      }
    }

    function updatePlaceCardHighlights() {
      document.querySelectorAll('.place-card').forEach(card => {
        card.classList.toggle('active', card.dataset.id === AppState.selectedPlaceId);
      });
    }

    function updateSlotHighlights() {
      document.querySelectorAll('.itinerary-slot').forEach(slot => {
        slot.classList.toggle('active', slot.dataset.id === AppState.selectedPlaceId);
      });
    }

    function updateInPlanMarkers() {
      document.querySelectorAll('.place-card').forEach(card => {
        card.classList.toggle('in-plan', isPlaceInPlan(card.dataset.id));
      });
    }

    // ============================================
    // Interactions
    // ============================================
    function selectPlace(placeId, source) {
      AppState.selectedPlaceId = placeId;
      const place = getPlaceById(placeId);
      if (!place) return;

      // Highlight marker
      MapAdapter.highlightMarker(placeId);

      // Update list highlight
      updatePlaceCardHighlights();
      updateSlotHighlights();

      if (source !== 'map') {
        MapAdapter.panTo(place.lat, place.lng, 16);
        MapAdapter.openPopup(placeId);
      }

      if (source !== 'list') {
        const card = document.querySelector(`.place-card[data-id="${placeId}"]`);
        if (card) card.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }

      if (source !== 'itinerary') {
        const slot = document.querySelector(`.itinerary-slot[data-id="${placeId}"]`);
        if (slot) slot.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }
    }

    function toggleCategory(code) {
      if (AppState.activeCategories.has(code)) {
        AppState.activeCategories.delete(code);
      } else {
        AppState.activeCategories.add(code);
      }
      render(['activeCategories']);
    }

    function changeSortBy(value) {
      AppState.sortBy = value;
      render(['sortBy']);
    }

    // ============================================
    // Panel Toggle
    // ============================================
    function initPanelToggles() {
      const container = document.getElementById('appContainer');
      const leftToggle = document.getElementById('leftToggle');
      const rightToggle = document.getElementById('rightToggle');

      leftToggle.textContent = '‚óÄ';
      rightToggle.textContent = '‚ñ∂';

      leftToggle.addEventListener('click', () => {
        AppState.leftPanelOpen = !AppState.leftPanelOpen;
        container.classList.toggle('left-collapsed', !AppState.leftPanelOpen);
        leftToggle.textContent = AppState.leftPanelOpen ? '‚óÄ' : '‚ñ∂';
        MapAdapter.invalidateSize();
      });

      rightToggle.addEventListener('click', () => {
        AppState.rightPanelOpen = !AppState.rightPanelOpen;
        container.classList.toggle('right-collapsed', !AppState.rightPanelOpen);
        rightToggle.textContent = AppState.rightPanelOpen ? '‚ñ∂' : '‚óÄ';
        MapAdapter.invalidateSize();
      });
    }

    // ============================================
    // Travel Plan Operations
    // ============================================
    function addToPlan(placeId) {
      const place = getPlaceById(placeId);
      if (!place || isPlaceInPlan(placeId)) return;

      const day = AppState.travelPlan.days[AppState.activeDay - 1];
      day.places.push({ ...place });
      render(['travelPlan']);
    }

    function removeFromPlan(slotIndex) {
      const day = AppState.travelPlan.days[AppState.activeDay - 1];
      const removed = day.places.splice(slotIndex, 1)[0];
      if (removed) {
        delete day.notes[removed.id];
        delete day.timeSlots[removed.id];
      }
      render(['travelPlan']);
    }

    function switchDay(dayNum) {
      AppState.activeDay = dayNum;
      render(['activeDay', 'travelPlan']);
    }

    function addDay() {
      const num = AppState.travelPlan.days.length + 1;
      AppState.travelPlan.days.push({ label: `${num}ÏùºÏ∞®`, places: [], notes: {}, timeSlots: {} });
      AppState.activeDay = num;
      render(['activeDay', 'travelPlan']);
    }

    function clearDay() {
      const day = AppState.travelPlan.days[AppState.activeDay - 1];
      day.places = [];
      day.notes = {};
      day.timeSlots = {};
      render(['travelPlan']);
    }

    function updateTimeSlot(placeId, field, value) {
      const day = AppState.travelPlan.days[AppState.activeDay - 1];
      if (!day.timeSlots[placeId]) day.timeSlots[placeId] = {};
      day.timeSlots[placeId][field] = value;
    }

    function updateNote(placeId, value) {
      const day = AppState.travelPlan.days[AppState.activeDay - 1];
      day.notes[placeId] = value;
    }

    // ============================================
    // Route Optimization (Nearest Neighbor)
    // ============================================
    function optimizeRoute() {
      const day = AppState.travelPlan.days[AppState.activeDay - 1];
      if (!day || day.places.length < 2) return;

      const places = [...day.places];
      const optimized = [places[0]];
      const remaining = places.slice(1);

      while (remaining.length > 0) {
        const last = optimized[optimized.length - 1];
        let nearestIdx = 0;
        let nearestDist = Infinity;

        remaining.forEach((p, i) => {
          const d = haversineDistance(last.lat, last.lng, p.lat, p.lng);
          if (d < nearestDist) {
            nearestDist = d;
            nearestIdx = i;
          }
        });

        optimized.push(remaining.splice(nearestIdx, 1)[0]);
      }

      day.places = optimized;
      render(['travelPlan']);
    }

    // ============================================
    // Drag & Drop: Place Card ‚Üí Itinerary
    // ============================================
    let draggedPlaceId = null;
    let draggedSlotIndex = null;

    function onPlaceDragStart(e, placeId) {
      draggedPlaceId = placeId;
      draggedSlotIndex = null;
      e.dataTransfer.effectAllowed = 'copy';
      e.dataTransfer.setData('text/plain', placeId);
      e.target.classList.add('dragging');
    }

    function onSlotDragStart(e, index) {
      draggedSlotIndex = index;
      draggedPlaceId = null;
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', String(index));
      e.target.classList.add('dragging');
    }

    function onSlotDragOver(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = draggedPlaceId ? 'copy' : 'move';
    }

    function onSlotDrop(e, targetIndex) {
      e.preventDefault();
      e.stopPropagation();

      if (draggedSlotIndex !== null && draggedSlotIndex !== targetIndex) {
        // Reorder within itinerary
        const day = AppState.travelPlan.days[AppState.activeDay - 1];
        const [moved] = day.places.splice(draggedSlotIndex, 1);
        day.places.splice(targetIndex, 0, moved);
        render(['travelPlan']);
      }
      cleanup();
    }

    // Drop on itinerary container
    document.getElementById('dayItinerary').addEventListener('dragover', e => {
      e.preventDefault();
      e.currentTarget.classList.add('drag-over');
    });
    document.getElementById('dayItinerary').addEventListener('dragleave', e => {
      e.currentTarget.classList.remove('drag-over');
    });
    document.getElementById('dayItinerary').addEventListener('drop', e => {
      e.preventDefault();
      e.currentTarget.classList.remove('drag-over');

      if (draggedPlaceId && !isPlaceInPlan(draggedPlaceId)) {
        addToPlan(draggedPlaceId);
      }
      cleanup();
    });

    function cleanup() {
      draggedPlaceId = null;
      draggedSlotIndex = null;
      document.querySelectorAll('.dragging').forEach(el => el.classList.remove('dragging'));
    }
    document.addEventListener('dragend', cleanup);

    // ============================================
    // localStorage Save / Load
    // ============================================
    const STORAGE_KEY = 'map-search-travel-plans';

    function savePlan() {
      const data = {
        savedAt: new Date().toISOString(),
        query: APP_DATA.query,
        title: AppState.travelPlan.title || APP_DATA.query,
        travelPlan: AppState.travelPlan,
        places: APP_DATA.places
      };
      const plans = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
      plans.push(data);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(plans));
      showToast('Ïó¨Ìñâ Í≥ÑÌöçÏù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§');
    }

    function openLoadModal() {
      const plans = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
      const listEl = document.getElementById('savedPlansList');

      if (plans.length === 0) {
        listEl.innerHTML = '<p style="color:var(--color-text-muted);text-align:center;padding:20px">Ï†ÄÏû•Îêú Í≥ÑÌöçÏù¥ ÏóÜÏäµÎãàÎã§</p>';
      } else {
        listEl.innerHTML = plans.map((plan, i) => `
          <div class="saved-plan-item" onclick="loadPlan(${i})">
            <div class="plan-name">${plan.title || plan.query}</div>
            <div class="plan-date">${new Date(plan.savedAt).toLocaleDateString('ko-KR')} ${new Date(plan.savedAt).toLocaleTimeString('ko-KR', {hour:'2-digit',minute:'2-digit'})}</div>
          </div>
        `).join('');
      }
      document.getElementById('loadModal').classList.add('visible');
    }

    function closeLoadModal() {
      document.getElementById('loadModal').classList.remove('visible');
    }

    // Close modal on ESC key
    document.addEventListener('keydown', e => {
      if (e.key === 'Escape') {
        const modal = document.getElementById('loadModal');
        if (modal.classList.contains('visible')) closeLoadModal();
      }
    });

    // Close modal on overlay click
    document.getElementById('loadModal').addEventListener('click', e => {
      if (e.target === e.currentTarget) closeLoadModal();
    });

    function loadPlan(index) {
      const plans = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
      if (plans[index]) {
        AppState.travelPlan = plans[index].travelPlan;
        AppState.activeDay = 1;
        render(['travelPlan', 'activeDay']);
        closeLoadModal();
        showToast('Ïó¨Ìñâ Í≥ÑÌöçÏùÑ Î∂àÎü¨ÏôîÏäµÎãàÎã§');
      }
    }

    // ============================================
    // Toast Notification
    // ============================================
    function showToast(message) {
      const toast = document.createElement('div');
      toast.setAttribute('role', 'status');
      toast.setAttribute('aria-live', 'polite');
      toast.style.cssText = `
        position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%);
        background: var(--color-text); color: white; padding: 12px 24px;
        border-radius: 999px; font-size: 0.85rem; font-weight: 500; z-index: 3000;
        box-shadow: var(--shadow-lg); animation: fadeIn 0.3s ease;
        transition: opacity 0.3s ease;
      `;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => { toast.style.opacity = '0'; }, 2000);
      setTimeout(() => toast.remove(), 2300);
    }

    // ============================================
    // Mobile Panel Toggle
    // ============================================
    function showMobilePanel(panel) {
      const left = document.getElementById('leftPanel');
      const right = document.getElementById('rightPanel');
      const tabs = document.querySelectorAll('.mobile-bar .tab-btn');

      left.classList.remove('mobile-open');
      right.classList.remove('mobile-open');
      tabs.forEach(t => { t.classList.remove('active'); t.setAttribute('aria-selected', 'false'); });

      if (panel === 'left') {
        left.classList.add('mobile-open');
        tabs[0].classList.add('active');
        tabs[0].setAttribute('aria-selected', 'true');
      } else if (panel === 'right') {
        right.classList.add('mobile-open');
        tabs[2].classList.add('active');
        tabs[2].setAttribute('aria-selected', 'true');
      } else {
        tabs[1].classList.add('active');
        tabs[1].setAttribute('aria-selected', 'true');
        MapAdapter.invalidateSize();
      }
    }

    // ============================================
    // Auto-populate dayGroup places
    // ============================================
    function autoPopulateDayGroups() {
      APP_DATA.places.forEach(place => {
        if (place.dayGroup !== null && place.dayGroup !== undefined) {
          const dayIdx = place.dayGroup - 1;
          // Ensure day exists
          while (AppState.travelPlan.days.length <= dayIdx) {
            const num = AppState.travelPlan.days.length + 1;
            AppState.travelPlan.days.push({ label: `${num}ÏùºÏ∞®`, places: [], notes: {}, timeSlots: {} });
          }
          // Avoid duplicates
          const day = AppState.travelPlan.days[dayIdx];
          if (!day.places.some(p => p.id === place.id)) {
            day.places.push({ ...place });
          }
        }
      });
    }

    // ============================================
    // Init
    // ============================================
    function init() {
      const center = APP_DATA.searchParams.location || { lat: 37.5665, lng: 126.9780 };

      // Init map
      MapAdapter.init('map', center, CONFIG.defaultZoom);

      // Auto-populate travel plan from dayGroup
      autoPopulateDayGroups();

      // Set default title
      if (!AppState.travelPlan.title) {
        AppState.travelPlan.title = APP_DATA.query;
      }

      // Render everything
      renderLeftHeader();
      renderScenarioBanners();
      renderLegend();
      renderRightHeader();
      render(['activeCategories', 'sortBy', 'travelPlan', 'activeDay']);

      // Fit map to all places
      MapAdapter.fitBounds(APP_DATA.places);

      // Panel toggles
      initPanelToggles();

      // Draw itinerary route for active day
      MapAdapter.drawItineraryRoute(AppState.activeDay);
    }

    // Start
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
